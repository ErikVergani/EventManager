/**
 * Filename:    EventService.java
 *
 * Description: Implementation of the EventService class.
 *
 * Revision:    15 de abr. de 2024
 *
 * Author:      Erik Freire Vergani
 * EMail:       efvergani@hotmail.com.br
 *
 */

package com.univates.api.services;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import com.univates.api.models.Event;
import com.univates.api.models.Registration;
import com.univates.api.models.User;
import com.univates.api.records.request.EventRecord;
import com.univates.api.records.response.EventResponseRecord;
import com.univates.api.repositories.EventRepository;
import com.univates.api.repositories.RegistrationRepository;

/**
 * @author ev
 */
@Service
public class EventService
{
    @Autowired
    private EventRepository eventRepository;
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private RegistrationRepository registrationRepository;
    
    /**
     * getAll
     * 
     * @return List <Event>
     */
    public ResponseEntity <List<EventResponseRecord>> getAll()
    {
        return ResponseEntity.status( HttpStatus.OK ).body( eventRepository.findByDataBeforeTomorrow() );
    }
    
    /**
     * getEvent
     *
     * @param id Integer
     * @return Event
     */
    public Event getEvent( Integer id )
    {
        return eventRepository.findById( id ).orElse( null );
    }
    
    /**
     * saveEvent
     * 
     * @param er EventRecord
     * @return ResponseEntity<EventResponseRecord>
     */
    public ResponseEntity <Object> saveEvent( EventRecord er )
    {
        Event event = new Event();
        BeanUtils.copyProperties( er, event );
        eventRepository.save( event );
        
        return ResponseEntity.status( HttpStatus.CREATED ).body( new EventResponseRecord( event.getName(), event.getDate() ) );
    }
    
    /**
     * saveEvent
     * 
     * @param id Integer
     * @param er EventRecord
     * @return ResponseEntity<EventResponseRecord>
     */
    public ResponseEntity<Object> saveEvent( Integer id, EventRecord er )
    {
        Optional <Event> ev = eventRepository.findById( id );
        
        if ( ev.isEmpty() )
        {
            return ResponseEntity.status( HttpStatus.NOT_FOUND ).body( "Event not found!" );
        }
        
        Event event = ev.get();
        BeanUtils.copyProperties( er, event );
        eventRepository.save( event );
        
        return ResponseEntity.status( HttpStatus.OK ).body( new EventResponseRecord( event.getName(), event.getDate() ) );
    }

    /**
     * getUserEvents
     *
     */
    public ResponseEntity <Object> getUserEvents( Integer id )
    {
        User user = userService.getUser( id );
        
        if (user == null )
        {
            return ResponseEntity.status( HttpStatus.NOT_FOUND ).body( "User not found!" );
        }
        
        List <Registration> registrations =  registrationRepository.findByUser( user );

        List<EventResponseRecord> er = new ArrayList <EventResponseRecord>();
        
        eventRepository.findByRegistrationsIn( registrations ).forEach( e -> er.add( new EventResponseRecord( e.getName(), e.getDate() ) ) );
        
        return ResponseEntity.status( HttpStatus.OK ).body( er );
    }
}
