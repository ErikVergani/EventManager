/**
 * Filename:    RegistrationService.java
 *
 * Description: Implementation of the RegistrationService class.
 *
 * Revision:    15 de abr. de 2024
 *
 * Author:      Erik Freire Vergani
 * EMail:       efvergani@hotmail.com.br
 *
 */

package com.univates.api.services;

import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import com.univates.api.enums.RegistrationState;
import com.univates.api.models.Event;
import com.univates.api.models.Registration;
import com.univates.api.models.User;
import com.univates.api.records.request.RegistrationRecord;
import com.univates.api.records.response.RegistrationResponseRecord;
import com.univates.api.repositories.RegistrationRepository;

/**
 * @author ev
 */
@Service
public class RegistrationService
{
    @Autowired
    private RegistrationRepository registrationRepository;
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private EventService eventService;
    
    @Autowired
    private EmailService emailService;
    
    /**
     * getRegistrations
     *
     */
    public List<RegistrationResponseRecord> getRegistrations( User user )
    {
        List<RegistrationResponseRecord> records = new ArrayList <RegistrationResponseRecord>();
        
        registrationRepository.findByUser( user ).forEach( r -> records.add( new RegistrationResponseRecord( r ) ) );
        
       return records;
    }
    
    /**
     * getRegistration
     *
     */
    public Optional <Registration> getRegistration( Integer eventId, Integer userId )
    {
        return registrationRepository.findByEventAndUser( eventService.getEvent( eventId ), userService.getUser( userId ) );
    }
    
    /**
     * addRegistration
     *
     */
    public ResponseEntity<RegistrationResponseRecord> addRegistration( RegistrationRecord rr )
    {
        User user = userService.getUser( rr.userId() );
        Event event = eventService.getEvent( rr.eventId() );
        
        if ( user == null || event == null )
        {
            return ResponseEntity.status( HttpStatus.BAD_REQUEST ).body( "User or Event not found!" );
        }
        
        if ( !registrationRepository.findByEventAndUser( event, user ).isEmpty() )
        {
            return ResponseEntity.status( HttpStatus.BAD_REQUEST ).body( "User already registered" );
        }
        
        Registration registration = new Registration();
        
        registration.setUser( user );
        registration.setEvent( event );
        
        registrationRepository.save( registration );
        emailService.sendEventRegister( user, event, registration.getRegisterDate() );
        
        return ResponseEntity.status( HttpStatus.CREATED ).body( new RegistrationResponseRecord( user.getName(), event.getName(), registration.getState().toString(), registration.getRegisterDate().format( DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm") ) ) );
    }


    /**
     * cancelRegistration
     *
     */
    public ResponseEntity <RegistrationResponseRecord> cancelRegistration( Integer eventId, Integer userId )
    {
        Optional <Registration> r = getRegistration( eventId, userId );
        
        if ( r.isEmpty() )
        {
            return ResponseEntity.status( HttpStatus.NOT_FOUND ).body( null );
        }
        
        Registration registration = r.get();
        
        if ( registration.getState() == RegistrationState.CANCELED )
        {
            return ResponseEntity.status( HttpStatus.BAD_REQUEST ).body( null );
        }
        
        registration.setState( RegistrationState.CANCELED );
        
        emailService.sendCancelationEmail( registration.getUser(), registration.getEvent() );
        registrationRepository.save( registration );
        
        return ResponseEntity.status( HttpStatus.OK ).body( new RegistrationResponseRecord( registration.getUser().getName(), registration.getEvent().getName(), registration.getState().toString(), registration.getRegisterDate().format( DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm") ) ) );
    }


    /**
     * checkIn
     *
     */
    public ResponseEntity<Object> checkIn( Integer eventId, Integer userId )
    {
        Optional <Registration> r =  getRegistration( eventId, userId );
        
        if ( r.isEmpty() )
        {
            return ResponseEntity.status( HttpStatus.NOT_FOUND ).body( "Registration not found!" );
        }
        
        Registration registration = r.get();
        
        if ( registration.getState() == RegistrationState.CHECK_IN_DONE )
        {
            return ResponseEntity.status( HttpStatus.BAD_REQUEST ).body( "Check-in already done!" );
        }
        
        registration.setState( RegistrationState.CHECK_IN_DONE );
        
        emailService.sendCheckinConfirmation( registration.getUser(), registration.getEvent() );
        registrationRepository.save( registration );
        
        return ResponseEntity.status( HttpStatus.OK ).body( new RegistrationResponseRecord( registration.getUser().getName(), registration.getEvent().getName(), registration.getState().toString(), registration.getRegisterDate().format( DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm") ) ) );
    }
}
